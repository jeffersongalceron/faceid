<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Capture DOC</title>
    <!-- Bootstrap CSS via CDN (ou faça o download e referencie localmente) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="css/default.css" rel="stylesheet">
    <script>
        //Impedir a rotação automática
        window.addEventListener('orientationchange', function () {
            if (window.orientation !== 0) {
                alert("Você precisa bloquear a rotação do celular para continuar!");
                location.reload();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            if (window.orientation !== 0) {
                alert("Você precisa bloquear a rotação do celular para continuar!");
                location.reload();
            }
        });

    </script>

    <!-- <script>
    document.getElementById('permitirCamera').addEventListener('click', function() {
      // Solicitar permissão de acesso à câmera
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          console.log('Permissão concedida');
          // Recarregar a página após conceder permissão
          location.reload();
        })
        .catch(function(error) {
          console.log('Erro ao conceder permissão:', error);
        });
    });
    </script> -->




</head>

<body>

    <div class="container mt-5">
        <h4 class="mb-4" style="text-align: center; " id="tituloPG"></h4>
    </div>

    <div id="grid-video" class="text-center">
        <video id="camera" autoplay playsinline width="100%" height="30%"></video>
    </div>

    <!-- Resultados do console style="opacity: 0.6; " -->

    <div id="img-capturada" class="mt-3" style="display: none; text-align: center;">
        <div style="position: relative; margin-bottom: 20px;">
            <img id="imagemCapturada" alt="Imagem Capturada" class="img-fluid">
            <div id="barraSimulada"
                style="position: absolute; top: 0; left: 0; height: 100%; width: 10px; background-color: rgb(0, 255, 55); animation: simularValidacao 2s linear infinite;">
            </div>
        </div>
    </div>

    <!-- Botão para capturar imagem -->
    <div class="text-center mt-3">
        <button class="btn btn-primary rounded-circle" style="position: relative; color: #0d6efd; padding: 30px;"
            id="bt_camera" onclick="capturarImagem();"></button>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 FACEID BRASIL |
            <p id="versao"></p>
            </p>
        </div>
    </footer>

</body>
<!-- Tesseract.js via CDN -->
<script src="./js/tesseract.min.js"></script>
<script src="./js/app.js"></script>

<script>
    // Faça uma requisição para o arquivo versao.txt
    fetch('versao.txt')
        .then(response => response.text())
        .then(data => {
            // Atualize o conteúdo do parágrafo com a versão
            document.getElementById('versao').textContent = data;
        })
        .catch(error => {
            console.error('Erro ao ler versao.txt:', error);
        });
</script>

<script>




    const tituloPG = document.getElementById('tituloPG');
    var tipoDoc = "0"

    if (!localStorage.getItem('frenteDocumento')) {
        novoConteudo = 'Parte da <strong style="color: green;">Frente</strong> RG ou CNH, na posição indicada'
    } else {
        novoConteudo = 'Parte <strong>Verso</strong> RG ou CNH';
        tipoDoc = "1"
    }

    tituloPG.innerHTML = novoConteudo;

    async function iniciarCamera() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(device => device.kind === 'videoinput');

            // Encontre a câmera traseira (se disponível)
            const cameraTraseira = cameras.find(camera => camera.label.toLowerCase().includes('back'));

            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    deviceId: cameraTraseira ? { exact: cameraTraseira.deviceId } : undefined,
                }
            });

            const camera = document.getElementById('camera');
            camera.srcObject = stream;
        } catch (error) {
            console.error('Erro ao acessar a câmera:', error);
        }
    }

    function validaOCR() {

        // Obtenha o URL do Blob armazenado no localStorage
        const blobURL = localStorage.getItem('dadosFormulario');

        // Faça uma requisição Fetch para obter o Blob
        fetch(blobURL)
            .then(response => response.blob())
            .then(blob => {
                // Use FileReader para ler o conteúdo do Blob
                const reader = new FileReader();
                reader.onload = function (event) {
                    // O conteúdo do Blob está disponível em event.target.result
                    const conteudoBlob = event.target.result;
                    console.log(conteudoBlob);

                    // Aqui você pode processar o conteúdo do Blob conforme necessário
                };

                // Leia o Blob como texto
                reader.readAsText(blob);
            })
            .catch(error => console.error('Erro ao buscar o Blob:', error));


    }

    // Função para encontrar palavras comuns entre duas listas
    function encontrarPalavrasComuns(lista2) {
        const palavrasComuns = [];

        const dadosFormulario = JSON.parse(localStorage.getItem('dadosFormulario'));

        // Percorre a primeira lista
        for (let palavra of dadosFormulario) {
            // Verifica se a palavra está presente na segunda lista
            if (lista2.includes(palavra)) {
                // Adiciona a palavra à lista de palavras comuns
                palavrasComuns.push(palavra);
            }
        }

        return palavrasComuns;
    }

    async function capturarImagem() {
        const camera = document.getElementById('camera');

        // Crie um canvas temporário para capturar a imagem
        const canvas = document.createElement('canvas');

        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;

        const contexto = canvas.getContext('2d');
        contexto.drawImage(camera, 0, 0, canvas.width, canvas.height);

        // Exiba a imagem capturada em uma tag de imagem
        const imagemCapturada = document.getElementById('imagemCapturada');
        imagemCapturada.src = canvas.toDataURL('image/png');

        // Simule a validação com a barra passando
        const barraSimulada = document.getElementById('barraSimulada');
        barraSimulada.style.animation = 'simularValidacao 2s linear infinite';

        // Exiba a div com a imagem capturada
        const divCapturada = document.getElementById('img-capturada');
        divCapturada.style.display = 'inline';

        // Esconde botao e Camera
        const divbt_camera = document.getElementById('bt_camera');
        bt_camera.style.display = 'none';

        const divcamera = document.getElementById('camera');
        camera.style.display = 'none';

        // Realize OCR na imagem
        const result = await Tesseract.recognize(
            canvas,
            'por', // Define o idioma para português
            { logger: info => console.log(info) } // Função de callback para exibir informações no console
        );

        const ocrDOC = {
            "tipoDoc": tipoDoc,
            "ocr": result.data.text
        };

        const jsonString = JSON.stringify(ocrDOC);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const blobURL = URL.createObjectURL(blob);

        console.log(result.data.text); // Exibe o texto extraído no console
        //alert(result.data.text); // Mostra o texto extraído em um alerta
        // Envia o texto para a API em localhost:8000/status

        const textoExtraido = result.data.text;
        const palavras = textoExtraido.split(' ').map(palavra => palavra.toUpperCase());


        const palavrasComuns = encontrarPalavrasComuns(palavras);

        //alert(palavrasComuns)


        if (tipoDoc == 0) {
            if (palavrasComuns.length > 0) {
                localStorage.setItem('frenteDocumento', "0000000f-97dc-4ddc-96f8-82c63a58aa2d");


            }
            else {
                localStorage.setItem('frenteDocumento', "0000000ff-97dc-4ddc-96f8-82c63a58aa2d");


            }

            const base64Image = canvas.toDataURL('image/jpeg');


            const base64ImageResumida = base64Image.split(',')[1];

            //Validar Documento
            const apiUrl = 'http://127.0.0.1:8000/b2xbet/server'

            // Faz a requisição POST para a API
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: base64ImageResumida }), // 
            })
                .then(response => response.json())
                .then(data => {
                    
                    if(data.prediction !=="OFICIAL"){
                        localStorage.removeItem('dadosFormulario')
                        localStorage.removeItem('totalFaceDoc')
                        localStorage.removeItem('facedoc')
                        localStorage.removeItem('frenteDocumento')
                        localStorage.removeItem('imagemCapturadaBase64f')
                        window.location.href = 'valida.html';
                        return false;
                    }

                })
                .catch(error => console.error('Erro ao enviar para a API:', error));


            localStorage.setItem('imagemCapturadaBase64f', base64ImageResumida);
        }
        if (tipoDoc != 0) {
            if (palavrasComuns.length > 0) {
                localStorage.setItem('versoDocumento', "0000000v-97dc-4ddc-96f8-82c63a58aa2d");
            } else {
                localStorage.setItem('versoDocumento', "0000000fv-97dc-4ddc-96f8-82c63a58aa2d");
            }

            const base64Image = canvas.toDataURL('image/jpeg');
            const base64ImageResumida = base64Image.split(',')[1];
            localStorage.setItem('imagemCapturadaBase64v', base64ImageResumida);

        }



        //enviarTextoParaAPI(result.data.text);

        processaImagem();

    }

    function enviarTextoParaAPI(base64) {


        // Define a URL da API
        const apiUrl = 'https://api.tuse.com.br/b2xbet/server';
        //const apiUrl = 'http://127.0.0.1:8000/b2xbet/server'

        // Faz a requisição POST para a API
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image: base64 }), // 
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);



            })
            .catch(error => console.error('Erro ao enviar para a API:', error));
    }

    function processaImagem() {
        // Obtém a referência da imagem
        const imagemFrente = document.querySelector('#imagemFrente');

        // Aguarde 1 segundo (1000 milissegundos) antes de substituir a imagem
        setTimeout(() => {
            const divCapturada = document.getElementById('img-capturada');
            divCapturada.style.display = 'none';

            if (tipoDoc == 0) {
                window.location.href = 'capture-doc-img.html';
            } else {
                window.location.href = 'face.html';
            }
        }, 500);
    }

    window.onload = iniciarCamera;

    // if (localStorage.getItem('facedoc')){
    //     ocr()
    // }

    // setTimeout(() => {
    //     capturarImagem()
    // }, 3000);
</script>

</html>